name: CI

on:
    push:
        branches: [master]
    pull_request:

concurrency:
    group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
    cancel-in-progress: true

permissions:
    contents: read
    pages: write
    id-token: write

jobs:
    # Lint PR titles with commitlint
    lint-pr:
        name: Lint PR Title
        if: github.event_name == 'pull_request'
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4

            - uses: pnpm/action-setup@v4

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: 22.x
                  cache: "pnpm"

            - name: Install dependencies
              run: pnpm install --frozen-lockfile
              env:
                  HUSKY: "0"

            - name: Lint PR title
              run: echo "${{ github.event.pull_request.title }}" | pnpm exec commitlint

    # Build job - runs once, shares artifacts with test shards
    build:
        name: Build
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - uses: pnpm/action-setup@v4

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: 22.x
                  cache: "pnpm"

            - name: Install dependencies
              run: pnpm install --frozen-lockfile
              env:
                  HUSKY: "0"

            - name: Security audit
              run: pnpm audit --audit-level=high

            - name: Cache Nx
              uses: actions/cache@v4
              with:
                  path: .nx/cache
                  key: nx-${{ runner.os }}-build-${{ hashFiles('pnpm-lock.yaml') }}-${{ github.sha }}
                  restore-keys: |
                      nx-${{ runner.os }}-build-${{ hashFiles('pnpm-lock.yaml') }}-
                      nx-${{ runner.os }}-build-

            # PR: Build and lint affected packages only
            - name: Build affected (PR)
              if: github.event_name == 'pull_request'
              run: pnpm exec nx affected -t build --parallel=3

            - name: Lint affected (PR)
              if: github.event_name == 'pull_request'
              run: pnpm exec nx affected -t lint --parallel=3

            # Master: Build and lint all packages
            - name: Build all (master)
              if: github.ref == 'refs/heads/master' && github.event_name == 'push'
              run: pnpm exec nx run-many -t build --parallel=3

            - name: Lint all (master)
              if: github.ref == 'refs/heads/master' && github.event_name == 'push'
              run: pnpm exec nx run-many -t lint --parallel=3

            - name: Dead code detection (knip)
              run: pnpm run lint:knip

            - name: Upload pupt-lib build
              uses: actions/upload-artifact@v4
              with:
                  name: build-pupt-lib
                  path: pupt-lib/dist/
                  retention-days: 1

            - name: Upload pupt build
              uses: actions/upload-artifact@v4
              with:
                  name: build-pupt
                  path: pupt/dist/
                  retention-days: 1

            - name: Upload pupt-react build
              uses: actions/upload-artifact@v4
              with:
                  name: build-pupt-react
                  path: pupt-react/dist/
                  retention-days: 1

            - name: Upload pupt-test build
              uses: actions/upload-artifact@v4
              with:
                  name: build-pupt-test
                  path: pupt-test/dist/
                  retention-days: 1

    # Sharded test jobs - run in parallel, collect coverage
    test:
        name: Test (${{ matrix.shard }})
        needs: build
        runs-on: ubuntu-latest
        strategy:
            fail-fast: false
            matrix:
                shard:
                    - pupt
                    - pupt-lib-node
                    - pupt-lib-browser
                    - pupt-react
                    - pupt-sde-prompts
                    - pupt-test
                include:
                    - shard: pupt
                      package: pupt
                      test-command: cd pupt && pnpm exec vitest run --coverage
                      needs-browser: false
                    - shard: pupt-lib-node
                      package: pupt-lib
                      test-command: cd pupt-lib && pnpm exec vitest run --project=node --coverage
                      needs-browser: false
                    - shard: pupt-lib-browser
                      package: pupt-lib
                      test-command: cd pupt-lib && pnpm exec vitest run --project=browser --coverage
                      needs-browser: true
                    - shard: pupt-react
                      package: pupt-react
                      test-command: cd pupt-react && pnpm exec vitest run --coverage
                      needs-browser: true
                    - shard: pupt-sde-prompts
                      package: pupt-sde-prompts
                      test-command: cd pupt-sde-prompts && pnpm exec vitest run
                      needs-browser: false
                    - shard: pupt-test
                      package: pupt-test
                      test-command: cd pupt-test && pnpm exec vitest run
                      needs-browser: false

        steps:
            - uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - uses: pnpm/action-setup@v4

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: 22.x
                  cache: "pnpm"

            - name: Install dependencies
              run: pnpm install --frozen-lockfile
              env:
                  HUSKY: "0"

            - name: Download pupt-lib build
              uses: actions/download-artifact@v4
              with:
                  name: build-pupt-lib
                  path: pupt-lib/dist/

            - name: Download pupt build
              if: matrix.shard == 'pupt'
              uses: actions/download-artifact@v4
              with:
                  name: build-pupt
                  path: pupt/dist/

            - name: Download pupt-react build
              if: matrix.shard == 'pupt-react'
              uses: actions/download-artifact@v4
              with:
                  name: build-pupt-react
                  path: pupt-react/dist/

            - name: Download pupt-test build
              if: matrix.shard == 'pupt-sde-prompts'
              uses: actions/download-artifact@v4
              with:
                  name: build-pupt-test
                  path: pupt-test/dist/

            - name: Cache Playwright browsers
              if: matrix.needs-browser
              uses: actions/cache@v4
              id: playwright-cache
              with:
                  path: ~/.cache/ms-playwright
                  key: playwright-${{ runner.os }}-${{ hashFiles('pnpm-lock.yaml') }}

            - name: Install Playwright browsers
              if: matrix.needs-browser && steps.playwright-cache.outputs.cache-hit != 'true'
              run: pnpm exec playwright install chromium --with-deps

            - name: Install Playwright deps (if cached)
              if: matrix.needs-browser && steps.playwright-cache.outputs.cache-hit == 'true'
              run: pnpm exec playwright install-deps chromium

            - name: Run tests
              run: ${{ matrix.test-command }}
              env:
                  # Disable per-shard coverage thresholds; thresholds are only
                  # meaningful when all projects' coverage is merged together.
                  VITEST_COVERAGE_NO_THRESHOLDS: "true"

            - name: Upload coverage
              if: ${{ !cancelled() }}
              uses: actions/upload-artifact@v4
              with:
                  name: coverage-${{ matrix.shard }}
                  path: ${{ matrix.package }}/coverage/lcov.info
                  retention-days: 1
                  if-no-files-found: ignore

    # Merge coverage reports and upload to Coveralls
    coverage:
        name: Coverage
        needs: [test]
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4

            - uses: pnpm/action-setup@v4

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: 22.x
                  cache: "pnpm"

            - name: Install dependencies
              run: pnpm install --frozen-lockfile
              env:
                  HUSKY: "0"

            - name: Download coverage artifacts
              uses: actions/download-artifact@v4
              with:
                  pattern: coverage-*
                  merge-multiple: false

            - name: Place coverage in package directories
              run: |
                  # Move coverage artifacts into their package directories
                  # so lcov-result-merger can compute repo-relative paths
                  declare -A ARTIFACT_TO_PKG=(
                    [coverage-pupt]="pupt"
                    [coverage-pupt-lib-node]="pupt-lib"
                    [coverage-pupt-lib-browser]="pupt-lib"
                    [coverage-pupt-react]="pupt-react"
                    [coverage-pupt-sde-prompts]="pupt-sde-prompts"
                  )

                  for artifact_dir in coverage-*/; do
                    name=$(basename "$artifact_dir")
                    pkg="${ARTIFACT_TO_PKG[$name]}"
                    if [ -n "$pkg" ] && [ -f "${artifact_dir}lcov.info" ]; then
                      mkdir -p "$pkg/coverage"
                      cp "${artifact_dir}lcov.info" "$pkg/coverage/${name}.info"
                      echo "Placed: ${artifact_dir}lcov.info -> $pkg/coverage/${name}.info"
                    fi
                  done

            - name: Merge coverage reports
              run: |
                  mkdir -p coverage
                  pnpm exec lcov-result-merger "*/coverage/coverage-*.info" --prepend-source-files > coverage/lcov.info
                  echo "Merged coverage: $(grep -c '^SF:' coverage/lcov.info) source files"
                  grep '^SF:' coverage/lcov.info | head -5

            - name: Upload coverage to Coveralls
              uses: coverallsapp/github-action@v2
              with:
                  github-token: ${{ secrets.GITHUB_TOKEN }}
                  file: coverage/lcov.info

    # Build documentation and demo sites
    docs-build:
        name: Build Documentation
        needs: build
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4

            - uses: pnpm/action-setup@v4

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: 22.x
                  cache: "pnpm"

            - name: Setup Pages
              uses: actions/configure-pages@v4
              with:
                  enablement: true

            - name: Install dependencies
              run: pnpm install --frozen-lockfile
              env:
                  HUSKY: "0"

            - name: Download pupt-lib build
              uses: actions/download-artifact@v4
              with:
                  name: build-pupt-lib
                  path: pupt-lib/dist/

            - name: Download pupt build
              uses: actions/download-artifact@v4
              with:
                  name: build-pupt
                  path: pupt/dist/

            - name: Download pupt-react build
              uses: actions/download-artifact@v4
              with:
                  name: build-pupt-react
                  path: pupt-react/dist/

            - name: Build pupt-lib documentation
              run: cd pupt-lib && npm run docs:build

            - name: Build pupt documentation
              run: cd pupt && npm run docs:build

            - name: Build pupt-react demo
              run: cd pupt-react && npm run build:demo

            - name: Assemble site
              run: |
                  mkdir -p _site
                  cp -r pupt-lib/docs/.vitepress/dist _site/lib
                  cp -r pupt/docs/.vitepress/dist _site/cli
                  cp -r pupt-react/dist-demo _site/demo
                  # Create landing page
                  cat > _site/index.html << 'LANDING'
                  <!DOCTYPE html>
                  <html lang="en">
                  <head>
                    <meta charset="UTF-8">
                    <meta name="viewport" content="width=device-width, initial-scale=1.0">
                    <title>PUPT - Powerful Universal Prompt Tool</title>
                    <style>
                      body { font-family: system-ui, sans-serif; max-width: 600px; margin: 80px auto; padding: 0 20px; color: #333; }
                      h1 { margin-bottom: 0.5em; }
                      p { color: #666; }
                      ul { list-style: none; padding: 0; }
                      li { margin: 12px 0; }
                      a { color: #3451b2; text-decoration: none; font-weight: 500; }
                      a:hover { text-decoration: underline; }
                    </style>
                  </head>
                  <body>
                    <h1>PUPT</h1>
                    <p>Powerful Universal Prompt Tool - documentation and demos</p>
                    <ul>
                      <li><a href="lib/">@pupt/lib - Core JSX Prompt Library</a></li>
                      <li><a href="cli/">@pupt/cli - CLI Tool</a></li>
                      <li><a href="demo/">@pupt/react - Interactive Demo</a></li>
                    </ul>
                  </body>
                  </html>
                  LANDING

            - name: Upload pages artifact
              uses: actions/upload-pages-artifact@v3
              with:
                  path: _site

    # Deploy documentation to GitHub Pages (master only)
    docs-deploy:
        name: Deploy Documentation
        needs: [coverage, docs-build]
        runs-on: ubuntu-latest
        if: github.ref == 'refs/heads/master' && github.event_name == 'push'
        environment:
            name: github-pages
            url: ${{ steps.deployment.outputs.page_url }}
        steps:
            - name: Deploy to GitHub Pages
              id: deployment
              uses: actions/deploy-pages@v4

    # Gate job - ensures all required checks pass before release
    all-checks:
        name: All Checks Pass
        needs: [lint-pr, build, test, coverage, docs-build]
        if: always()
        runs-on: ubuntu-latest
        steps:
            - name: Check all jobs passed
              run: |
                  echo "lint-pr: ${{ needs.lint-pr.result }}"
                  echo "build: ${{ needs.build.result }}"
                  echo "test: ${{ needs.test.result }}"
                  echo "coverage: ${{ needs.coverage.result }}"
                  echo "docs-build: ${{ needs.docs-build.result }}"

                  # lint-pr only runs on PRs, allow skipped on push
                  if [[ "${{ needs.lint-pr.result }}" != "success" && "${{ needs.lint-pr.result }}" != "skipped" ]]; then
                    echo "::error::lint-pr failed"
                    exit 1
                  fi
                  if [[ "${{ needs.build.result }}" != "success" ]]; then
                    echo "::error::Build failed"
                    exit 1
                  fi
                  if [[ "${{ needs.test.result }}" != "success" ]]; then
                    echo "::error::Tests failed"
                    exit 1
                  fi
                  if [[ "${{ needs.coverage.result }}" != "success" ]]; then
                    echo "::error::Coverage failed"
                    exit 1
                  fi
                  if [[ "${{ needs.docs-build.result }}" != "success" ]]; then
                    echo "::error::Docs build failed"
                    exit 1
                  fi
                  echo "All checks passed!"

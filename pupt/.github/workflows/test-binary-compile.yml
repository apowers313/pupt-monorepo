name: Test Binary Compilation

on:
  workflow_dispatch:

jobs:
  test-compile:
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            binary-name: pt-test
          - os: macos-latest
            binary-name: pt-test
          - os: windows-latest
            binary-name: pt-test.exe

    runs-on: ${{ matrix.os }}
    name: ${{ matrix.os }}

    steps:
      - uses: actions/checkout@v4

      - uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install bun-pty
        run: bun add --no-save @skitee3000/bun-pty

      # Step 1: Test bun-pty works in runtime
      - name: Generate runtime wrapper
        run: bun test/bun-windows-prototype/generate-pty-wrapper.ts runtime

      - name: Test PTY in Bun runtime
        run: bun test/bun-windows-prototype/pty-wrapper.ts

      # Step 2: Compile to standalone binary
      - name: Generate compile wrapper
        run: bun test/bun-windows-prototype/generate-pty-wrapper.ts compile

      - name: Compile to standalone binary
        run: bun build test/bun-windows-prototype/pty-wrapper.ts --compile --outfile tmp/${{ matrix.binary-name }}

      - name: Show binary size
        shell: bash
        run: ls -lh tmp/${{ matrix.binary-name }}

      # Step 3: Run compiled binary from a different directory
      - name: Test compiled binary (Linux/macOS)
        if: runner.os != 'Windows'
        run: |
          cd /tmp
          "$GITHUB_WORKSPACE/tmp/${{ matrix.binary-name }}"

      - name: Test compiled binary (Windows)
        if: runner.os == 'Windows'
        shell: cmd
        run: |
          cd %TEMP%
          "%GITHUB_WORKSPACE%\tmp\${{ matrix.binary-name }}"

      # Step 4: Also test compiling the full pupt CLI
      - name: Install project dependencies
        run: npm ci

      - name: Build TypeScript
        run: npm run build

      - name: Generate CLI wrapper
        run: bun test/bun-windows-prototype/generate-cli-wrapper.ts

      - name: Compile full CLI to binary
        run: |
          bun build test/bun-windows-prototype/pty-wrapper-cli.ts --compile --outfile tmp/pt-full-${{ matrix.binary-name }} --external @homebridge/node-pty-prebuilt-multiarch
        continue-on-error: true

      - name: Test full CLI binary version (Linux/macOS)
        if: runner.os != 'Windows'
        run: ./tmp/pt-full-${{ matrix.binary-name }} --version || echo "Full CLI test failed"
        continue-on-error: true

      - name: Test full CLI binary version (Windows)
        if: runner.os == 'Windows'
        run: tmp\pt-full-${{ matrix.binary-name }} --version || echo "Full CLI test failed"
        continue-on-error: true
